---
title: "Kinship Approaches in Demography or The Elementary Structures of Kinship"
date: "Formal Demography Working Group - Feb 2022"
header-includes:
  - \usepackage{amsmath}
bibliography: kinship.bib
output:
  bookdown::html_document2:
    keep_md: true
    number_sections: true
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: 
      collapsed: true
---

<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

<!-- author: | -->
<!--    | Diego Alburez-Gutierrez, -->
<!--    | Lab of Digital and Computational Demography, -->
<!--    | Max Planck Institute for Demographic Research -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("functions.R")

# Install pagages if needed
library(DemoKin)
library(tidyverse)
library(knitr)
library(ggrepel)
library(latex2exp)
```

Get the `Rmd` version of this file: https://github.com/alburezg/kinship_formal_demo.

# What is kinship demography?

Kinship is relevant for:

- Socialisation, protection, and sustenance
- Inter-generational solidarity: exchanges and bequests
- Social structure and identity
- Early-life conditions $\rightarrow$ later-life outcomes

## Studies with a strong kinship component

- Mortality shocks on kinship structure [@zagheni_impact_2011;@verdery_tracking_2020]
- Kinship transitions: [@murphy_long-term_2011;@verdery_links_2015] 
- Bereavement: [@alburez-gutierrez_womens_2021;@smith-greenaway_global_2021]
- Kin availability: [@wachter_kinship_1997;@alburezgutierrez_sandwich_2021] 
- Grandparenthood [@margolis_changing_2016;@margolis_cohort_2019;@verdery2017projections]
- Other social phenomena: [@alburez-gutierrez_demographic_2021;@song2021role]
<!-- - Inheritance of demographic behaviour: Kolk  -->
<!-- - Generational overlap:  -->

# Demographic kinship structures

## Implied demographic characteristics

Let's review the principle of demographic ergodicity:

> A closed population with unchanging mortality and fertility rates has an implied (a) Intrinsic rate of natural increase $r$ and (2) age structure. 

According to Wachter [-@wachter_essential_2014], the proportion of the population aged $x$ to $x+n$ in a stationary population is:

\begin{equation}
  \frac{_{n}K_{x}}{_{\infty}K_{0}} = b\frac{_{n}L_{x}}{l_{0}}
(\#eq:ageStat)
\end{equation}

where:


- $_{n}K_{x}$ is the size of the population aged $x$ to $x+n$
- $b$ is the Crude Birth Rate
- $_{n}L_{x}$ are person-years lived, and
- $l_{0}$ is the radix

```{r}

# Swedish life tables:
# https://www.mortality.org/hmd/SWE/STATS/bltcoh_5x10.txt

lt <- 
  read.table("fltper_1x10.txt", header = T, skip = 2) %>% 
  # Pick an arbitrary year
  filter(Year == "1900-1909") %>% 
  select(Age, lx, Lx) 

  # Crude birh rate from HFD
  # https://www.humanfertility.org/cgi-bin/country.php?country=SWE&tab=si
  
CBR <- read.table("SWEcbrRR.txt", header = T, skip = 2)

# Function to get implied age structure in stationary population

get_ageg_size <- function(age_keep, ...){

  l0 <- lt$lx[1]
  
  nLx <- 
    lt %>% 
    filter(Age == age_keep) %>% 
    pull(Lx)
  
  
b <- CBR %>% 
    filter(Year == "1905") %>% 
    pull(CBR)
  
  out <- b * (nLx / l0)
  names(out) <- age_keep
  
  out
}


ageg_size <- 
  lapply(lt$Age, get_ageg_size) %>% 
  unlist() 

# Get proportions

ageg_prop <- ageg_size / sum(ageg_size)

ageg_prop %>% 
  data.frame %>% 
  rownames_to_column("Age") %>% 
  mutate(Age = as.numeric(Age)) %>% 
  ggplot(aes(x = Age, y = ageg_prop, group = 1)) +
  geom_line() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  labs(y = "Proportion of total population", title = "Implied age structure in a stationary population") +
  theme_bw()

```


We can generalise this to a stable population:

\begin{equation}
  \frac{_{n}K_{x}}{_{\infty}K_{0}} = b\frac{_{n}L_{x}}{l_{0}}e^{-rx}
(\#eq:ageStab)
\end{equation}


where:

- $r$ is the intrinsic rate of natural increase


## Stable populations also have an intrinsic kinship structure

According to Goodman et al [-@goodman_family_1974]:

> A ﬁxed set of age-speciﬁc rates implies the probability that a girl aged *a* has a living mother and great-grandmother, as well as her expected number of daughters, sisters, aunts, nieces, and cousins. [@Keyfitz2005]

For example, this is the expected number of kin for an woman aged 80 ('Ego') in a female population that experiences the 1950 Swedish demographic rates ad-infinitum:

```{r, echo=F}
# An example using our package DemoKin, which will be explained later

# library(DemoKin)
swe50_1950_stable <- 
  kins(
    ego_age = 80
    , year = 1950
    , P = swe_surv
    , asfr = swe_asfr
    , stable = TRUE
    )

plot_diagram(swe50_1950_stable[["kins_total"]])
```

## The Goodman-Keyfitz-Pullum (GKP) kinship equations

### Living ancestors

The probability that a girl aged $a$ has a living mother in a stable population is:


\begin{equation}
M_1(a) = \int_{\alpha}^{\beta}{\frac{l(x+a)}{l(x)} e^{-rx}l(x)m(x) \:dx}
(\#eq:m1a)
\end{equation}

where

- $\alpha$ and $\beta$ represent the start and the end of the reproductive period
- $m_x$ is a vector of age-specific fertility rates
- is a vector of survival probabilities $l_x$

Conditional on ego's survival, $M_1{(a)}$ can be thought of as a survival probability in a life table: it has to be equal to one when $a$ is equal to zero (the mother is alive when she gives birth), and goes monotonically to zero. 

We can also approximate $M_1(a)$ in relation to the mean age at childbearing $\mu$.
Assuming $\mu$ to be the average length of a generation in a stable population, we can rewrite Eq. \@ref(eq:m1a) as follows:

\begin{equation}
M_1(a) \approx \frac{l_{\mu + a}}{l_{\mu}}.
(\#eq:approx)
\end{equation}

We can visualise this in a Lexis Diagram [@Keyfitz2005]:

```{r, echo=F,message=FALSE,warning=FALSE}
lexis1()
```


Eq. \@ref(eq:approx) states that the probability that a girl alive at age $a$ has a living mother is approximately equal to the probability that women in the population are alive $a$ years past the mean age at childbearing, conditional on them being alive at the mean age at childbearing.

```{r, fig.height=6, fig.width=8}
swe50_1950_stable[["kins_by_age_ego"]] %>%
  select(x, m) %>% 
  gather(kin, count, -x) %>%
  ggplot() +
  geom_line(aes(x, count))  +
  theme_bw() +
  labs(x = "Ego's age", y = "Probability that mother is alive") 
```

To generalise to older generations, let us first define the age distribution of women as $W(x) = e^{-rx}l(x)m(x)$, so that Eq. \@ref(eq:m1a) becomes:

\begin{equation}
M_1(a) = \int_{\alpha}^{\beta}{\frac{l(x+a)}{l(x)} W(x)  dx}.
(\#eq:m1a)
\end{equation}

The average number of grandmothers is:

\begin{equation}
M_2(a) = \int_{\alpha}^{\beta}{ M_1(x+a) W(x) \:dx};
\label{eq:m2a}
\end{equation}

of great-grandmothers:

\begin{equation}
M_3(a) = \int_{\alpha}^{\beta}{ M_2(x+a) W(x) \:dx};
\label{eq:m3a}
\end{equation}

and so on.

```{r, fig.height=6, fig.width=8}
swe50_1950_stable[["kins_by_age_ego"]] %>%
  select(x, `A. grandmother` = gm, `B. great-grandmother` = ggm) %>% 
  gather(kin, count, -x) %>%
  ggplot() +
  geom_line(aes(x, count))  +
  theme_bw() +
  labs(x = "Ego's age", y = "Expected number of surviving") +
  facet_wrap(~kin)
```

### Living descendants

The average number of surviving children is:

\begin{equation}
B_1(a) = \int_{\alpha}^{a}{m(x) l(a-x) \: dx}
 (\#eq:b1)
\end{equation}

The expected number of surviving grandchildren is: 

\begin{equation}
B_2(a) = \int_{\alpha}^{a}{m(x)\int_{\alpha}^{a-x}{l(y) m(y) \: dy }\:dx}.
\label{eq:b2}
\end{equation}

```{r, fig.height=6, fig.width=8}
swe50_1950_stable[["kins_by_age_ego"]] %>%
  select(x, daughter = d, granddaughter = gd) %>% 
  gather(kin, count, -x) %>%
  ggplot() +
  geom_line(aes(x, count))  +
  theme_bw() +
  labs(x = "Ego's age", y = "Expected number of surviving") +
  facet_wrap(~kin)
```

### Other relatives

The GKP recursive approach can get messy quickly. Consider the expected number of first cousins from the mother's older sisters' side:


\begin{equation}
C_1(a) = \int_{\alpha}^{\beta} {\left[ \int_{\alpha}^{\beta}{ \left\{ \int_{\alpha}^{y}{\left( \int_{\alpha}^{a+x+y-z}{l(w)m(w) \: dw} \right)} m(z) \: dz \right\}  } \: W(y) \: dy \right] \: W(x) \: dx},
    \label{eq:cousin1}
\end{equation}

where $W(x)$ is the age distribution of the women:

\begin{equation}
W(x) = e^{-rx}l(x)m(x).
    \label{wx}
\end{equation}

```{r, fig.height=6, fig.width=8}
swe50_1950_stable[["kins_by_age_ego"]] %>%
  select(x, `younger aunt` = cya, `older aunt` = coa) %>% 
  gather(kin, count, -x) %>%
  ggplot() +
  geom_line(aes(x, count))  +
  theme_bw() +
  labs(x = "Ego's age", y = "Expected number of surviving cousins through") +
  facet_wrap(~kin)
```

### Assumptions and parameters

1. Stable vs non-stable populations
1. One-sex vs two-sex populations
1. Recursive vs matrix implementations
1. Analytic vs microsimulation

### Removing the stable assumption

Demographic rates change constantly in the real world - populations are rarely stable. Each of the stable identities given above have a non-stable equivalent, but we won't cover these given time limitations. As an example, consider the non-stable equivalent of the GKP equation for the number of surviving children is. 

First, remember the stable equation presented in Eq.\@ref(eq:b1):

\begin{equation}
M_1(a) = \int_{\alpha}^{a}{m(x) l(a-x) \: dx}.
\end{equation}

The expected number of surviving children for an average woman aged $a$ born in year $c$ in a non-stable population is:

\begin{equation}
M_1(a,c) = \sum_{x=\alpha}^{a}{F(x,c) l(a-x,c+x)}
\label{eq:b1_dic}
\end{equation}

where 

- $_1F_{(x,c)}$ represents age-specific fertility rates for cohort $c$ at age $x$
- $l_{(a-x,c+x)}$ are the survival probability until age $(a-x)$ for the cohort born in year $(c+x)$. It is the probability that the children of a woman who gave birth at age $x$ will survive until the woman potentially reaches age $a$. 

Note that the $(a-x,c+x)$ subscript allows us to replace the assumption of demographic stability present in the original formulation of the GKP equations with empirical rates.


# Matrix Kinship Models

New developments by [@caswell_formal_2019;@caswell_formal_2020;@caswell_formal_2021;@caswell2021formal_two-sex].

Let $\textbf{b}(x+1)$ be the population of Ego's granddaughters at time $(x+1)$ ($\textbf{b}_{0} = \textbf{0}$ because Ego has no granddaughters at birth), $\textbf{U}$ be a matrix with survival probabilities in the subdiagonal, $\textbf{F}$ be a matrix with fertility rates in the first row and zeros elsewhere, and $\textbf{a}$ be the population of surviving daughters at time $x$:

\begin{equation}
\label{eq:matrix}
    \underbrace{\textbf{b}(x+1)}_{\substack{\text{Population of}\\ \text{granddaughters}}} = \underbrace{\textbf{Ub}(x)}_{\text{Granddaughter survival}}  + \underbrace{\textbf{Fa}(x).}_{\substack{\text{Granddaughters}\\ \text{born from daughters}}}
\end{equation}

# DemoKin: An R package to estimate kinship networks in stable and non-stable populations

**Iván Williams, Diego Alburez-Gutierrez, and Xi Song**; https://github.com/IvanWilli/DemoKin

## Kin counts in stable populations

We can estimate this in a **stable** framework using data from 1995, assuming that all of Egos' relatives experience mortality and fertility from that calendar year (Caswell, 2019). The `DemoKin` package includes data from Sweden as an example (*swe_surv*, *swe_asfr* and *swe_pop*, for survival, fertility and population; type `data(package="DemoKin")`). This data comes from the [Human Mortality Database](https://www.mortality.org/) and [Human Fertility Database](https://www.humanfertility.org/). These datasets were loaded using the`get_HMDHFD` function. 

```{r}
swe35_1950_stable <- 
  kins(
    ego_age = 100
    , year = 1950
    , P = swe_surv
    , asfr = swe_asfr
    , stable = TRUE
    , alive = "yes"
    )
```

Let's visualize the distribution of relatives over ego's lifecourse:

```{r, fig.height=6, fig.width=8}
swe35_1950_stable[["kins_by_age_ego"]] %>%
              gather(kin, count, -x) %>%
              ggplot() +
              geom_line(aes(x, count))  +
              geom_vline(xintercept = 35, color=2)+
              theme_bw() +
              labs(x = "Ego's age") +
              facet_wrap(~kin)
```

Where each relative type is identified by a unique code:

```{r, fig.height=6, fig.width=8, echo=FALSE}

relatives <- c(
  "coa" = "Cousins (through aunt older than mother)"
  , "cya" = "Cousins (through aunt younger than mother)"
  , "d" = "Daughter"
  , "gd" = "Grand-daughter"
  , "ggm" = "Great-grandmother"
  , "gm" = "Grandmother"
  , "m" = "Mother"
  , "nos" = "Nieces through older sister"
  , "nys" = "Nieces through younger sister"
  , "oa" = "Aunt older than mother"
  , "ya" = "Aunt younger than mother"
  , "os" = "Older sister"
  , "ys" = "Younger sister"
  )

data.frame(Code = names(relatives), Relative = relatives, row.names = NULL) %>% kable()

```

We can also visualize the age distribution of relatives when Ego is 35:

```{r, fig.height=6, fig.width=8}
swe35_1950_stable[["kins_by_age_kin"]] %>%
              select(-x) %>% 
              gather(kin, count, -x_kin) %>%
              ggplot() +
              geom_line(aes(x_kin, count))  +
              geom_vline(xintercept = 35, color=2)+
              labs(x = "Age of kin") +
              theme_bw() +
              facet_wrap(~kin)
```


The function also includes data on the mean age of Ego's relatives at her actual age:

```{r, fig.height=6, fig.width=8}
swe35_1950_stable[["kins_mean_age"]] %>% 
  round(1) %>% 
  sort() %>% 
  t() %>% 
  kable()
```

We can visualize the estimated kin counts for Ego at age 35 in a stable population using a network diagram:

```{r, fig.height=10, fig.width=12}
plot_diagram(swe35_1950_stable[["kins_total"]])
```

## Experience of kin death

Kin loss has studied consequences related to mental health, care support and household incomes over life course. Setting the parameter `alive="no"` we can see how many relatives Ego loss during her life (output `kins_death_by_age_ego`), in a stable framework:

```{r, fig.height=6, fig.width=8}
swe35_1950_nonstable_death <- 
    kins(
    ego_age = 35
    , year = 1950
    , P = swe_surv
    , asfr = swe_asfr
    , stable = TRUE
    , alive = "no"
    )

swe35_1950_nonstable_death[["kins_cum_death_by_age_ego"]] %>%
  gather(kin, count, -x,) %>%
  ggplot() +
  geom_line(aes(x, count))  +
  geom_vline(xintercept = 35, color=2)+
  theme_bw() +
  facet_wrap(~kin,scales="free")
```

Given some portion of each relative was dead (remember we are talking about population measures), we can ask what was the mean age at lost for each kin:

```{r}
swe35_1950_nonstable_death[["lost_mean_age"]] %>% round(2)
```

# Applications: Women's experience of child death [@alburez-gutierrez_womens_2021]

*Research question*

How can we characterise the experience of offspring loss from the vantage point of mothers?

\begin{enumerate}
     \item Methods: formal methods from kinship demography
     \item Data: 2019 UN World Population Prospects estimates (1950-2020) and projections (2020-2100) for 201 countries 
     \item Results: global estimates of prevalence and incidence of offspring loss over life, across cohorts, and around the world
 \end{enumerate}

## The Child Death identity

In a non-stable population, the number of children ever born to a woman aged $a$ born in cohort $c$ standing before us will be equal to the number of children who are currently alive plus the children who died before the woman reached age $a$:


\begin{equation}
\underbrace{CD(a,c,n)}_{\text{Child deaths}}= \underbrace{\sum_{x=15}^{x=a} {_1F_{x}(c,n)}}_{\text{Children born}}-\underbrace{\sum_{x=15}^{x=a} {_1F_{x}(c,n)} l_{a-x}(c+x,n)}_{\text{Children surviving or } CS(a,c,n) }
(\#eq:CD)
\end{equation}

where 

- $_1F_{x}(c,n)$ are single-year age-specific fertility rates for cohort $c$ and country $n$, at age $x$. The lower age boundary in this and all models is 15, representing the start of a woman's reproductive life. 
- $l_{a-x}(c+x,n)$ is the survival probability until age $(a-x)$ for the cohort born in year $(c+x)$ in country $n$. It is the probability that the children of a woman who gave birth at age $x$ will survive until the woman potentially reaches age $a$.   

**Explore results using this online application: https://diego-alburez.shinyapps.io/child_death_demography/**

# Rsoc: Demographic microsimulations in R made easy (bonus)

**Tom Theile and Diego Alburez-Gutierrez**; https://github.com/tomthe/rsoc

Use the in-built functions in `Rsoc` to run a simple simulation from scratch. For this example, we'll just simulate a stable population. We don't have time to discuss SOCSIM simulations in full (the best introduction is still Carl Mason's  [SOCSIM oversimplified](https://lab.demog.berkeley.edu/socsim/CurrentDocs/socsimOversimplified.pdf) document). However, if you're interested, this is the 'instruction' file that we give to the simulator in order to simulate a stable population based on Sweden's 1950 demographic rates:

```{r, eval=T}
cat(readLines("rsoc/sim_test.sup"), sep = "\n")
```

Let's run the simulation using `rsoc`:

```{r, eval=T}
# library(rsoc)

folder <- "rsoc"
seed <- "42"

# name of the supplement-file, relative to the above folder:
supfile <- "sim_test.sup" 

# run1simulationwithfile starts a simulation with the specified sup-file
rsoc::run1simulationwithfile(folder, supfile, seed)
```

Now, let's replicate one of the measures we obtained with the formal model: the probability that an average member of the population has a living mother. 

First, we read the SOCSIM output:

```{r}
# Read simulation output population
opop <- read.table(file="rsoc/output_pop.opop", header=F, as.is=T)  
  
## assign names to columns
names(opop)<-c("pid","fem","group",
                 "nev","dob","mom","pop","nesibm","nesibp",
                 "lborn","marid","mstat","dod","fmult")
  
opop <- 
  opop %>% 
  # Transform to years
  mutate(
    birth_year = dob/12
    , death_year = dod/12
  ) %>% 
  select(pid, mom, pop, fem, birth_year, death_year) %>% 
  # fem = 1 for women!
  filter(fem == 1) %>% 
  # Remove founder generation (who have no mother)
  # People can still have no dads but that's fine because
  # Children of  unmarried couples get a 0 as id for their 
  # father by default.
  filter(!is.na(mom))
  
head(opop)

```

Now, we estimate the probability of having a living mother from the Socsim microdata:

```{r, message=FALSE, warning=FALSE}
# Estimates from SOCSIM
m1_soc <- 
left_join(
  opop %>% 
    filter(mom != 0) %>% 
    filter(birth_year >= 50) %>% 
    select(ego = pid, mom, ego_dob = birth_year)
  , opop %>% 
    select(mom = pid, mom_dod = death_year)
) %>% 
  mutate(ego_age_mom_death = mom_dod - ego_dob) %>% 
  filter(ego_age_mom_death > 0) %>% 
  count(age = ego_age_mom_death) %>% 
  arrange(age) %>% 
  mutate(count = 1 - cumsum(n)/sum(n)) %>% 
  select(age, count) %>% 
  mutate(source = "socsim")

m1_soc %>% 
  ggplot(aes(x = age, y = count, colour = source)) +
  geom_line() +
  labs(x = "Ego's age", y = "Probability that mother is alive") +
  theme_bw()

```

How does it compare with the model-derived values obtained from `DemoKin` above?

```{r}
# Get estimates from model
m1_mod <- 
  swe50_1950_stable[["kins_by_age_ego"]] %>%
  select(x, m) %>% 
  gather(kin, count, -x) %>% 
  select(age = x, count) %>% 
  mutate(source = "model")


bind_rows(m1_soc, m1_mod) %>% 
  ggplot(aes(x = age, y = count, colour = source)) +
  geom_line() +
  labs(x = "Ego's age", y = "Probability that mother is alive") +
  theme_bw()
```

They almost match entirely. Maybe if the simulation was a bit larger or if we ran more simulations, we would get a better fit?

Try running 5 simulations

```{r, eval = F}

run_random_simulation <- function(seed){

  seed <- as.character(seed)
  # seed <- as.character(sample(1:1000, 1))

  # Run simulations with random seed
  rsoc::run1simulationwithfile(
    folder = "rsoc"
      , supfile = "sim_test.sup" 
      , seed = seed
    )
  
# read output
  # Read simulation output population
  opop <- read.table(file="rsoc/output_pop.opop", header=F, as.is=T)  
  
  ## assign names to columns
  names(opop)<-c("pid","fem","group",
                 "nev","dob","mom","pop","nesibm","nesibp",
                 "lborn","marid","mstat","dod","fmult")
  
  opop <- 
    opop %>% 
    # Transform to years
    mutate(
      birth_year = dob/12
      , death_year = dod/12
    ) %>% 
    select(pid, mom, pop, fem, birth_year, death_year) %>% 
    filter(!is.na(mom))

  m1_soc <- 
    left_join(
      opop %>% 
        filter(mom != 0) %>% 
        filter(birth_year >= 50) %>% 
        select(ego = pid, mom, ego_dob = birth_year)
      , opop %>% 
        select(mom = pid, mom_dod = death_year)
    ) %>% 
    mutate(ego_age_mom_death = mom_dod - ego_dob) %>% 
    filter(ego_age_mom_death > 0) %>% 
    count(age = ego_age_mom_death) %>% 
    arrange(age) %>% 
    mutate(count = 1 - cumsum(n)/sum(n)) %>% 
    select(age, count) %>% 
    mutate(source = "socsim") %>% 
    mutate(seed = seed)
  
  m1_soc
}

m1_soc_sims <- 
  lapply(sample(1:1000, 5), run_random_simulation) %>% 
  bind_rows()

m1_soc_sims %>% 
  ggplot(aes(x = age, y = count, colour = seed)) +
  geom_line() +
  labs(x = "Ego's age", y = "Probability that mother is alive") +
  theme_bw()

```

## References